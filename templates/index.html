<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Real world scavanger hunt">
    <title>Scavange</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.76.1/src/L.Control.Locate.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.76.1/dist/L.Control.Locate.mapbox.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.76.1/dist/L.Control.Locate.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.76.1/dist/L.Control.Locate.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
    <script src="https://unpkg.com/cheap-ruler@3.0.1/cheap-ruler.js"></script>

 <style>
    html, body, #map {
            padding: auto;
            height: 100%;
            width: 100%;
         }
    footer {
        position: fixed;
        padding: 10px 10px 0px 10px;
        bottom: 0;
        width: 100%;
        height: 40px;
        text-align: center;
        margin: auto;
        z-index: 1;
    }
    header {
        position: fixed;
        padding: 10px 10px 0px 10px;
        top: 0;
        margin: auto;
        text-align: center;
        width: 100%;
        height: 40px;
        z-index: 22;
    }
    header > img {
        vertical-align: bottom;
    }
    .leaflet-marker-icon {
        z-index: -1;
    }
 </style>
</head>
<body>
    <!--battery icon at top-->
    <header id="charge">{{points}}&times;<a href="/leaderboard"><img src="/static/battery.png" alt="credits"></a></header>
    <div id="map"></div>
    <footer>
        {% for i in badges%}
            <a href="{{i[1]|safe}}" aria-label="{{i[2]}}"><img src="{{i[0]|safe}}" width="96px" height="28px" alt="{{i[2]}}"></a>
        {% endfor %}
    </footer>
</body>
<script>
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    var lat,lon;
    you = [{{lon}}, {{lat}}].reverse();
    svg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M408 120C408 174.6 334.9 271.9 302.8 311.1C295.1 321.6 280.9 321.6 273.2 311.1C241.1 271.9 168 174.6 168 120C168 53.73 221.7 0 288 0C354.3 0 408 53.73 408 120zM288 152C310.1 152 328 134.1 328 112C328 89.91 310.1 72 288 72C265.9 72 248 89.91 248 112C248 134.1 265.9 152 288 152zM425.6 179.8C426.1 178.6 426.6 177.4 427.1 176.1L543.1 129.7C558.9 123.4 576 135 576 152V422.8C576 432.6 570 441.4 560.9 445.1L416 503V200.4C419.5 193.5 422.7 186.7 425.6 179.8zM150.4 179.8C153.3 186.7 156.5 193.5 160 200.4V451.8L32.91 502.7C17.15 508.1 0 497.4 0 480.4V209.6C0 199.8 5.975 190.1 15.09 187.3L137.6 138.3C140 152.5 144.9 166.6 150.4 179.8H150.4zM327.8 331.1C341.7 314.6 363.5 286.3 384 255V504.3L192 449.4V255C212.5 286.3 234.3 314.6 248.2 331.1C268.7 357.6 307.3 357.6 327.8 331.1L327.8 331.1z"/></svg>'
    var map = L.map('map').setView(you, 17)//.locate({setView: true, maxZoom: 16});
    L.tileLayer('https://api.mapbox.com/styles/v1/yopo/cl3yq1zr3000014oaaez3upb0/tiles/512/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoieW9wbyIsImEiOiJjbDA0bzhoM2EwMWhiM2NxajV2Zm1lYmpyIn0.kL4KlQH8tl89C6dJtL31gw', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);
    var popup = L.popup()
    .setLatLng(you)
    .setContent("clicking the "+svg.replace('viewBox="0 0 576 512"', 'viewBox="0 0 576 512" width="25" height="25"')+" button will update your location")
    .openOn(map);
    L.Icon.Default.imagePath = "/static/markers/";
    var fallout = new L.icon({
        iconUrl: '/static/markers/fallout.png'
    })
    const ruler = new CheapRuler(you[1], 'meters');
    var locate = L.control.locate({
        locateOptions: {
            enableHighAccuracy: true
        },
        metric: false
    }).addTo(map);
    locate.start();
    you = you.reverse();
    coordinates = [];
    L.easyButton(svg, function(btn, map){
        data = {lat:lat,lon:lon}
        fetch("/update", {
            method: "POST",
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify(data)
          }).then(res => {
            location.reload();
          });
    }).addTo(map);
    {% for i in stuff%}
            var i = {{i|tojson}};
            popup = "<a href=https://www.google.com/maps/dir/?api=1&destination="+i.properties.lat+encodeURIComponent(", ")+i.properties.lon+"&travelmode=walking>"+i.properties.formatted+"</a>";
            if (i.properties.hasOwnProperty("name")) {
                popup = i.properties.name+"<br>("+popup+")";
            }
            if (i.properties.details.includes("details.artwork")) {
                popup = "<img src='/static/markers/art.png' width='16px'>"+popup
            } else if (i.properties.details.includes("details.building")) {
                popup = "<img src='/static/markers/building.png' width='16px'>"+popup
            }
            marker = L.marker([i.properties.lat, i.properties.lon], {icon: fallout}).addTo(map);
            marker.bindPopup(popup);
            coordinates.push({"id":i.properties.place_id,"coordinates":{"lat":i.properties.lat,"lon":i.properties.lon}})
            if (i.properties.details.length !== 0){
                console.log(i.properties);
            }

    {% endfor %}
    options = {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 0
      };
      var imageUrl = 'https://game-design-mb.herokuapp.com/static/markers/charge.gif'
      
      function success(pos) {
        var crd = pos.coords;
        lat=crd.latitude;
        lon=crd.longitude;
        coordinates.forEach((i) => {
            if (ruler.distance([crd.longitude, crd.latitude], [i.coordinates.lon, i.coordinates.lat]) < 50 && i.id !== urlParams.get("id")) {
                location.href = "http://"+location.host + "/point?id="+i.id

            }
        })
      }
      function error(err) {
          if (err.code === error.PERMISSION_DENIED){
              alert("this website requires location")
              alert("We do not share this information with anyone")
          }
        console.warn('ERROR(' + err.code + '): ' + err.message);
      }
    id = navigator.geolocation.watchPosition(success, error, options);

</script>
</html>